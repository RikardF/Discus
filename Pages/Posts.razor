@page "/posts/{categoryId}"
@using ExArbete.Shared.Components
@using ExArbete.Interfaces
@using Microsoft.AspNetCore.Authorization
@inject IHttpContextAccessor httpContextAccessor
@inject IUserService userService

<PageTitle>@categoryList?.Find(c => c.Id == CategoryId)?.Name</PageTitle>

@using ExArbete.Models
@using Google.Cloud.Firestore
@inject FirestoreDb firestoreDb

<h1>@categoryList?.Find(c => c.Id == CategoryId)?.Name</h1>

<AuthorizeView>
    <Authorized>
        @if(userService.IsNewUser)
        {
            <p>You need to complete your registration before entering this section.</p>
        } else {
            @foreach (Post post in postList.FindAll(p => p.CategoryId == CategoryId).OrderByDescending(p => p.CreatedAt))
            {
    <PostCard PostData=@post></PostCard>
}
        }
        

    </Authorized>
    <NotAuthorized>
        <p>You need to <NavLink href="/Identity/Account/Login">sign in</NavLink> to view this page</p>
    </NotAuthorized>
</AuthorizeView>


@code {
    [Parameter]
    public string? CategoryId { get; set; }
    [CascadingParameter]
    protected List<Category>? categoryList { get; set; }
    private FirestoreChangeListener? firestoreChangeListener;
    private List<Post> postList = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender){
            firestoreChangeListener = firestoreDb.Collection("posts")
                        @* .WhereEqualTo("category_id", CategoryId)
                        .OrderByDescending("created_at") *@
                        .Listen(async (snapshot) =>
                        {
                            postList.Clear();
                            postList.AddRange(snapshot.Documents.Select(d => d.ConvertTo<Post>()));
                            await InvokeAsync(() => StateHasChanged());
                        });
        }
        
        //postList = await GetPosts();
        //await InvokeAsync(() => StateHasChanged());
    }

    private async Task<List<Post>> GetPosts()
    {
        CollectionReference collection = firestoreDb.Collection("posts");
        Query byCategory = collection.WhereEqualTo("category_id", CategoryId).OrderByDescending("created_at");
        QuerySnapshot snapshot = await byCategory.GetSnapshotAsync();
        return snapshot.Documents.Select(d => d.ConvertTo<Post>()).ToList<Post>();
    }

    private async Task SubmitPost() {
        CollectionReference collection = firestoreDb.Collection("posts");
        Post post = new Post {
            Title = "Detta är en titel",
            Content = "Detta är content",
            CategoryId = "T160YqqlyYk5Ux2F3HsX",
            Likes = new List<string>(),
            SubPosts = new List<Post>(),
            CreatedAt = Timestamp.GetCurrentTimestamp()
        };
        DocumentReference doc = await collection.AddAsync(post);
    }

}
